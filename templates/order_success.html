{% extends "base.html" %}

{% block title %}è¨‚å–®æˆåŠŸ - è³¼ç‰©ç¶²ç«™{% endblock %}

{% block extra_css %}
<style>
    .success-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem;
        text-align: center;
    }

    .success-header {
        background: white;
        padding: 3rem 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .success-icon {
        width: 80px;
        height: 80px;
        background: #28a745;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 2rem;
        font-size: 2.5rem;
        color: white;
    }

    .success-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: #28a745;
        margin-bottom: 1rem;
    }

    .success-message {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    .order-details {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        text-align: left;
    }

    .order-details h3 {
        font-size: 1.5rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
        text-align: center;
    }

    .detail-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #dee2e6;
    }

    .detail-row:last-child {
        border-bottom: none;
    }

    .detail-label {
        font-weight: 600;
        color: #333;
    }

    .detail-value {
        color: #666;
    }

    .store-info {
        background: #e3f2fd;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
        border-left: 4px solid #2196f3;
    }

    .store-info .detail-label {
        color: #1976d2;
        font-weight: 600;
    }

    .store-info .detail-value {
        color: #1976d2;
        font-weight: 500;
    }

    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
    }

    .btn {
        padding: 1rem 2rem;
        border-radius: 10px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 1rem;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,123,255,0.3);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #545b62;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(108,117,125,0.3);
    }

    .loading-success {
        text-align: center;
        padding: 4rem 2rem;
    }

    .loading-spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @media (max-width: 768px) {
        .success-container {
            padding: 1rem;
        }

        .success-header {
            padding: 2rem 1rem;
        }

        .success-title {
            font-size: 2rem;
        }

        .action-buttons {
            flex-direction: column;
        }

        .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="success-container">
    <div id="successContainer">
        <div class="loading-success">
            <div class="loading-spinner"></div>
            <p>è¼‰å…¥è¨‚å–®è©³æƒ…ä¸­...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let orderDetails = null;

    // å¾ URL ç²å–è¨‚å–® ID
    function getOrderIdFromUrl() {
        const path = window.location.pathname;
        const match = path.match(/\/order-success\/(\d+)/);
        return match ? match[1] : null;
    }

    // è¼‰å…¥è¨‚å–®è©³æƒ…
    async function loadOrderDetails() {
        const orderId = getOrderIdFromUrl();
        if (!orderId) {
            showError('è¨‚å–® ID ç„¡æ•ˆ');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/orders/${orderId}`);
            if (!response.ok) {
                throw new Error('è¼‰å…¥è¨‚å–®å¤±æ•—');
            }
            
            orderDetails = await response.json();
            displayOrderSuccess();
            
        } catch (error) {
            console.error('è¼‰å…¥è¨‚å–®è©³æƒ…å¤±æ•—:', error);
            showError('è¼‰å…¥è¨‚å–®è©³æƒ…å¤±æ•—');
        }
    }

    // é¡¯ç¤ºè¨‚å–®æˆåŠŸé é¢
    function displayOrderSuccess() {
        if (!orderDetails) {
            showError('è¨‚å–®è³‡æ–™ç„¡æ•ˆ');
            return;
        }

        const subtotal = orderDetails.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const tax = subtotal * 0.1;
        const total = subtotal + tax;

        document.getElementById('successContainer').innerHTML = `
            <div class="success-header">
                <div class="success-icon">âœ“</div>
                <h1 class="success-title">è¨‚å–®æäº¤æˆåŠŸï¼</h1>
                <p class="success-message">
                    æ„Ÿè¬æ‚¨çš„è³¼è²·ï¼æˆ‘å€‘å·²æ”¶åˆ°æ‚¨çš„è¨‚å–®ï¼Œå°‡ç›¡å¿«ç‚ºæ‚¨è™•ç†ã€‚<br>
                    è¨‚å–®ç·¨è™Ÿï¼š<strong>#${orderDetails.id}</strong>
                </p>
            </div>

            <div class="order-details">
                <h3>è¨‚å–®è©³æƒ…</h3>
                <div class="detail-row">
                    <span class="detail-label">è¨‚å–®ç·¨è™Ÿ:</span>
                    <span class="detail-value">#${orderDetails.id}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">è¨‚å–®æ—¥æœŸ:</span>
                    <span class="detail-value">${new Date(orderDetails.order_date).toLocaleDateString('zh-TW')}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">å®¢æˆ¶å§“å:</span>
                    <span class="detail-value">${orderDetails.customer.first_name} ${orderDetails.customer.last_name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">é›»å­éƒµä»¶:</span>
                    <span class="detail-value">${orderDetails.customer.email}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">é›»è©±è™Ÿç¢¼:</span>
                    <span class="detail-value">${orderDetails.customer.phone}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">é€è²¨åœ°å€:</span>
                    <span class="detail-value">${orderDetails.customer.address}, ${orderDetails.customer.city}</span>
                </div>
                ${orderDetails.delivery_method ? `
                <div class="detail-row">
                    <span class="detail-label">å–è²¨æ–¹å¼:</span>
                    <span class="detail-value">${getDeliveryMethodText(orderDetails.delivery_method)}</span>
                </div>
                ` : ''}
                ${orderDetails.delivery_method === '711_store' && orderDetails.store_name ? `
                <div class="store-info">
                    <div class="detail-row">
                        <span class="detail-label">ğŸª å–è²¨é–€å¸‚:</span>
                        <span class="detail-value">${orderDetails.store_name}</span>
                    </div>
                    ${orderDetails.store_id ? `
                    <div class="detail-row">
                        <span class="detail-label">é–€å¸‚ä»£ç¢¼:</span>
                        <span class="detail-value">${orderDetails.store_id}</span>
                    </div>
                    ` : ''}
                    ${orderDetails.store_address ? `
                    <div class="detail-row">
                        <span class="detail-label">é–€å¸‚åœ°å€:</span>
                        <span class="detail-value">${orderDetails.store_address}</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
                <div class="detail-row">
                    <span class="detail-label">ä»˜æ¬¾æ–¹å¼:</span>
                    <span class="detail-value">${getPaymentMethodText(orderDetails.payment_method)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">è¨‚å–®ç‹€æ…‹:</span>
                    <span class="detail-value">${getStatusText(orderDetails.status)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">å•†å“æ•¸é‡:</span>
                    <span class="detail-value">${orderDetails.items.length} é …å•†å“</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">å°è¨ˆ:</span>
                    <span class="detail-value">$${subtotal.toFixed(2)}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">ç¨…è²»:</span>
                    <span class="detail-value">$${tax.toFixed(2)}</span>
                </div>
                <div class="detail-row" style="border-top: 2px solid #dee2e6; font-weight: 600; font-size: 1.1rem;">
                    <span class="detail-label">ç¸½è¨ˆ:</span>
                    <span class="detail-value">$${total.toFixed(2)}</span>
                </div>
            </div>

            <div class="action-buttons">
                <a href="/" class="btn btn-primary">ç¹¼çºŒè³¼ç‰©</a>
                <button class="btn btn-secondary" onclick="printOrder()">åˆ—å°è¨‚å–®</button>
            </div>
        `;
    }

    // ç²å–ä»˜æ¬¾æ–¹å¼æ–‡å­—
    function getPaymentMethodText(method) {
        const methods = {
            'credit_card': 'ä¿¡ç”¨å¡',
            'bank_transfer': 'éŠ€è¡Œè½‰å¸³',
            'cash_on_delivery': 'è²¨åˆ°ä»˜æ¬¾'
        };
        return methods[method] || method;
    }

    // ç²å–å–è²¨æ–¹å¼æ–‡å­—
    function getDeliveryMethodText(method) {
        const methods = {
            '711_store': '7-11åº—åˆ°åº—',
            'home_delivery': 'å®…é…åˆ°åºœ',
            'pickup': 'è‡ªå–'
        };
        return methods[method] || method;
    }

    // ç²å–ç‹€æ…‹æ–‡å­—
    function getStatusText(status) {
        const statuses = {
            'pending': 'è™•ç†ä¸­',
            'confirmed': 'å·²ç¢ºèª',
            'shipped': 'å·²å‡ºè²¨',
            'delivered': 'å·²é€é”',
            'cancelled': 'å·²å–æ¶ˆ'
        };
        return statuses[status] || status;
    }

    // é¡¯ç¤ºéŒ¯èª¤
    function showError(message) {
        document.getElementById('successContainer').innerHTML = `
            <div class="success-header">
                <div class="success-icon" style="background: #dc3545;">âœ—</div>
                <h1 class="success-title" style="color: #dc3545;">è¼‰å…¥å¤±æ•—</h1>
                <p class="success-message">${message}</p>
                <div class="action-buttons">
                    <a href="/" class="btn btn-primary">è¿”å›é¦–é </a>
                </div>
            </div>
        `;
    }

    // åˆ—å°è¨‚å–®
    function printOrder() {
        window.print();
    }

    // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        loadOrderDetails();
    });
</script>
{% endblock %}
